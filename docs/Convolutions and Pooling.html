---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: Convolutions and Pooling.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">get_datasets</span><span class="p">()</span>
<span class="n">m</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">lf</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">fit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">lf</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Reshaping-Tensor">Reshaping Tensor<a class="anchor-link" href="#Reshaping-Tensor">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Reshape" class="doc_header"><code>class</code> <code>Reshape</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L7" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Reshape</code>(<strong><code>channels</code></strong>, <strong><code>size1</code></strong>, <strong><code>size2</code></strong>) :: <a href="/ModernArchitecuturesFromScratch/TrainingLoop#Module"><code>Module</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Flatten" class="doc_header"><code>class</code> <code>Flatten</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Flatten</code>() :: <a href="/ModernArchitecuturesFromScratch/TrainingLoop#Module"><code>Module</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Initialization">Initialization<a class="anchor-link" href="#Initialization">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_fan" class="doc_header"><code>get_fan</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_fan</code>(<strong><code>dim1</code></strong>, <strong><code>dim2</code></strong>, <strong><code>dim3</code></strong>, <strong><code>dim4</code></strong>, <strong><code>fan_out</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_gain" class="doc_header"><code>get_gain</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L44" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_gain</code>(<strong><code>leak</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_weight" class="doc_header"><code>get_weight</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/fully_connected_network_02.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_weight</code>(<strong><code>in_d</code></strong>, <strong><code>out_d</code></strong>, <strong><code>final</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="k">import</span> <span class="n">init</span>
<span class="n">test_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">xt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_mnist</span><span class="p">()</span>
<span class="n">xt</span> <span class="o">=</span> <span class="n">xt</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="n">test_conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_stats</span><span class="p">(</span><span class="n">test_conv</span><span class="p">(</span><span class="n">xt</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_conv</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">get_weight</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span> 
<span class="n">get_stats</span><span class="p">(</span><span class="n">relu</span><span class="p">(</span><span class="n">test_conv</span><span class="p">(</span><span class="n">xt</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">init</span><span class="o">.</span><span class="n">kaiming_normal_</span><span class="p">(</span><span class="n">test_conv</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
<span class="n">get_stats</span><span class="p">(</span><span class="n">relu</span><span class="p">((</span><span class="n">test_conv</span><span class="p">(</span><span class="n">xt</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Padding">Padding<a class="anchor-link" href="#Padding">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Padding" class="doc_header"><code>class</code> <code>Padding</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L54" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Padding</code>(<strong><code>size</code></strong>=<em><code>1</code></em>, <strong><code>mode</code></strong>=<em><code>'constant'</code></em>, <strong><code>value</code></strong>=<em><code>0</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Forward">Forward<a class="anchor-link" href="#Forward">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="n">bs</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">im_h</span> <span class="o">=</span> <span class="n">im_w</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">w_dim</span> <span class="o">=</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">weight</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">stride</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">pad_amount</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f_dim</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">f_w</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">f_h</span> <span class="o">=</span> <span class="n">f_w</span>
<span class="n">test_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">w_dim</span><span class="p">,</span> <span class="n">f_dim</span><span class="p">,</span> <span class="n">f_w</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad_amount</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">test_conv</span><span class="o">.</span><span class="n">weight</span>
<span class="n">test_conv</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">test_conv</span><span class="o">.</span><span class="n">bias</span>
<span class="n">b</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pt_res</span> <span class="o">=</span> <span class="n">test_conv</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
<span class="n">pt_res</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="convolve" class="doc_header"><code>convolve</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L64" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>convolve</code>(<strong><code>weight</code></strong>, <strong><code>filts</code></strong>, <strong><code>filts_bias</code></strong>, <strong><code>stride</code></strong>=<em><code>1</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pad</span> <span class="o">=</span> <span class="n">Padding</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pad_amount</span><span class="p">)</span>
<span class="n">pad</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">pad</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pt_res</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Backward">Backward<a class="anchor-link" href="#Backward">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="conv_back" class="doc_header"><code>conv_back</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L85" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>conv_back</code>(<strong><code>out</code></strong>, <strong><code>inp</code></strong>, <strong><code>weight</code></strong>, <strong><code>bias</code></strong>, <strong><code>stride</code></strong>=<em><code>1</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Conv" class="doc_header"><code>class</code> <code>Conv</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L136" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Conv</code>(<strong><code>n_in</code></strong>, <strong><code>n_out</code></strong>, <strong><code>kernel_size</code></strong>=<em><code>3</code></em>, <strong><code>stride</code></strong>=<em><code>1</code></em>, <strong><code>leak</code></strong>=<em><code>1</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>) :: <a href="/ModernArchitecuturesFromScratch/TrainingLoop#Module"><code>Module</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pad1</span> <span class="o">=</span> <span class="n">Padding</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pad2</span> <span class="o">=</span> <span class="n">Padding</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_basic_conv_model</span><span class="p">(</span><span class="n">lr</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SequentialModel</span><span class="p">(</span><span class="n">Reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> 
                            <span class="n">Conv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">leak</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad1</span><span class="p">),</span> 
                            <span class="n">ReLU</span><span class="p">(),</span> 
                            <span class="n">Conv</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">leak</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad2</span><span class="p">),</span> 
                            <span class="n">Flatten</span><span class="p">(),</span> 
                            <span class="n">Linear</span><span class="p">(</span><span class="mi">288</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
    <span class="n">loss_func</span> <span class="o">=</span> <span class="n">CrossEntropy</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_func</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">get_basic_conv_model</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">loss_func</span> <span class="o">=</span> <span class="n">l</span>
<span class="n">xt</span><span class="p">,</span> <span class="n">yt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_mnist</span><span class="p">()</span>
<span class="n">sx</span><span class="p">,</span> <span class="n">sy</span> <span class="o">=</span> <span class="n">xt</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">yt</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">sx</span><span class="p">),</span> <span class="n">sy</span><span class="p">)</span>
<span class="n">loss_func</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sxg</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cw1g</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cb1g</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cw2g</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cb2g</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">lw</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">lb</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sx2</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">sx2</span><span class="p">),</span> <span class="n">sy</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">lw</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">cb2g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">cw2g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">cb1g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">cw1g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_linear_model" class="doc_header"><code>get_linear_model</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L154" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_linear_model</code>(<strong><code>lr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_model" class="doc_header"><code>get_model</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/training_loop_03.py#L134" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_model</code>(<strong><code>lr</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">Reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> 
     <span class="n">Conv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">leak</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
     <span class="n">ReLU</span><span class="p">(),</span> 
     <span class="n">Conv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">leak</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> 
     <span class="n">Flatten</span><span class="p">(),</span> 
     <span class="n">Linear</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>

<span class="n">m</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_small_datasets" class="doc_header"><code>get_small_datasets</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L167" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_small_datasets</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Pooling-Layers">Pooling Layers<a class="anchor-link" href="#Pooling-Layers">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="max_pool" class="doc_header"><code>max_pool</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L178" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>max_pool</code>(<strong><code>inp</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="avg_pool" class="doc_header"><code>avg_pool</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L179" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>avg_pool</code>(<strong><code>inp</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pool" class="doc_header"><code>pool</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L181" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pool</code>(<strong><code>inp</code></strong>, <strong><code>ks</code></strong>, <strong><code>stride</code></strong>, <strong><code>padding</code></strong>=<em><code>None</code></em>, <strong><code>operation</code></strong>=<em><code>'max_pool'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="n">ks</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">pad_size</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">py_max</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad_size</span><span class="p">)</span>
<span class="n">py_avg</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AvgPool2d</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">pad_size</span><span class="p">)</span>
<span class="n">py_max_result</span> <span class="o">=</span> <span class="n">py_max</span><span class="p">(</span><span class="n">test_t</span><span class="p">)</span>
<span class="n">py_avg_result</span> <span class="o">=</span> <span class="n">py_avg</span><span class="p">(</span><span class="n">test_t</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pad</span> <span class="o">=</span> <span class="n">Padding</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">pad_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">pad_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">my_avg</span> <span class="o">=</span> <span class="n">pool</span><span class="p">(</span><span class="n">test_t</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">avg_pool</span><span class="p">)</span>
<span class="n">my_max</span> <span class="o">=</span> <span class="n">pool</span><span class="p">(</span><span class="n">test_t</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">max_pool</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">py_max_result</span><span class="p">,</span> <span class="n">my_max</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">py_avg_result</span><span class="p">,</span> <span class="n">my_avg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="max_back" class="doc_header"><code>max_back</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L200" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>max_back</code>(<strong><code>window</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="average_back" class="doc_header"><code>average_back</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L211" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>average_back</code>(<strong><code>window</code></strong>, <strong><code>shape</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="pool_back" class="doc_header"><code>pool_back</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L216" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>pool_back</code>(<strong><code>out</code></strong>, <strong><code>inp</code></strong>, <strong><code>ks</code></strong>, <strong><code>stride</code></strong>, <strong><code>padding</code></strong>=<em><code>None</code></em>, <strong><code>operation</code></strong>=<em><code>'max_pool'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Pool" class="doc_header"><code>class</code> <code>Pool</code><a href="https://github.com/BradleyBrown19/ModernArchitecuturesFromScratch/tree/master/ModernArchitecuturesFromScratch/convolutions_pooling_04.py#L246" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Pool</code>(<strong><code>operation</code></strong>, <strong><code>ks</code></strong>=<em><code>2</code></em>, <strong><code>stride</code></strong>=<em><code>2</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>) :: <a href="/ModernArchitecuturesFromScratch/TrainingLoop#Module"><code>Module</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span>
          <span class="n">Conv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
          <span class="n">Pool</span><span class="p">(</span><span class="n">avg_pool</span><span class="p">,</span> <span class="n">ks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
          <span class="n">Conv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
          <span class="n">Flatten</span><span class="p">(),</span>
          <span class="n">Linear</span><span class="p">(</span><span class="mi">529</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
<span class="n">m</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
<span class="n">train</span><span class="p">,</span><span class="n">valid</span> <span class="o">=</span> <span class="n">get_small_datasets</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">sx</span><span class="p">),</span> <span class="n">sy</span><span class="p">)</span>
<span class="n">loss_func</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sxg</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cw</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">lw</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<span class="n">lb</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sx2</span> <span class="o">=</span> <span class="n">sx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">loss</span> <span class="o">=</span> <span class="n">loss_func</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="n">sx2</span><span class="p">),</span> <span class="n">sy</span><span class="p">)</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cw</span><span class="o">*</span><span class="mi">2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_near</span><span class="p">(</span><span class="n">sxg</span><span class="p">,</span> <span class="n">sx2</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">lw</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
<span class="n">test_near</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">grad</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

